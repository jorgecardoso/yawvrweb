<html>
<head>
</head>
<body>
<form action="/SET_POSITION" method="GET">
    Yaw: <input type="range" id="yaw" name="yaw" min="0" max="359" />
    Pitch: <input type="range" id="pitch" name="pitch" min="-180" max="180" />
    Roll: <input type="range" id="roll" name="roll" min="-180" max="180" />
    <input type="submit">
</form>

<form id="secondform" action="/SET_POSITION" method="GET">
    Yaw: <input type="number" id="yaw1" name="yaw" min="0" max="359" />
    Pitch: <input type="number" id="pitch1" name="pitch" min="-180" max="180" />
    Roll: <input type="number" id="roll1" name="roll" min="-180" max="180" />
    <input type="submit">
</form>

<script>
    let simulator = null;

    fetch("https://hmd-link-service.glitch.me/").then(function(page){
        return page.json();
    }).then(function(json){
       console.log(json);
       if (json.yawmiddleware) {
           console.log("Yaw Middleware found")
           begin(json.yawmiddleware.address);
       } else {
           console.log("Yaw Middleware not found");
       }

    }).catch(function(error){
        console.log(error);
    });

    function begin(simulatorAddress) {
        console.log("Starting communication with Yaw Middleware")
        let intervalId = setInterval(function() {
            fetch(simulatorAddress+"/simulators").then(function(data){
                return data.json();
            }).then(function(json){
                if (json.length > 0) {
                    console.log(json);
                    simulator = json[0];
                    console.log("connecting to " + json[0].simulatorId);
                    clearInterval(intervalId)
                    fetch(simulatorAddress+"/connect/" + json[0].simulatorId).then(function(resp){
                        return resp.json();
                    }).then(function(json){
                        console.log(json);

                        fetch(simulatorAddress+"/checkin/mysuperapp")
                            .then(function(res){ return res.json() })
                            .then(function(json) { console.log(json)})
                            .catch(function(res){ console.log(res) })

                        fetch(simulatorAddress+"/start")
                            .then(function(res){ console.log(res) })
                            .catch(function(res){ console.log(res) })
                    });
                }
            }).catch(function(error){
                console.log(error);
            });
        }, 10000);



        let y = document.querySelector("#yaw");
        let p = document.querySelector("#pitch");
        let r = document.querySelector("#roll");

        y.addEventListener("input", function(el){
            console.log(y.value);

            fetch(simulatorAddress+"/SET_POSITION/" + y.value +"/" +  p.value + "/" + r.value );
        });
        p.addEventListener("input", function(el){
            console.log(p.value);

            fetch(simulatorAddress+"/SET_POSITION/" + y.value +"/" +  p.value + "/" + r.value );
        });
        r.addEventListener("input", function(el){
            console.log(r.value);

            fetch(simulatorAddress+"/SET_POSITION/" + y.value +"/" +  p.value + "/" + r.value );
        });


        let y1 = document.querySelector("#yaw1");
        let p1 = document.querySelector("#pitch1");
        let r1 = document.querySelector("#roll1");

        function processForm(e) {
            if (e.preventDefault) e.preventDefault();

            fetch(simulatorAddress+"/SET_POSITION/" + y1.value +"/" +  p1.value + "/" + r1.value );
            // You must return false to prevent the default form behavior
            return false;
        }

        var form = document.getElementById('secondform');
        if (form.attachEvent) {
            form.attachEvent("submit", processForm);
        } else {
            form.addEventListener("submit", processForm);
        }
    }




</script>
</body>

</html>