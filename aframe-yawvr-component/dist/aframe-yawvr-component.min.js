!function(e,n){if("object"==typeof exports&&"object"==typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var t=n();for(var o in t)("object"==typeof exports?exports:e)[o]=t[o]}}(this,(()=>(()=>{if("undefined"==typeof AFRAME)throw new Error('Component "yawvr" attempted to register before AFRAME was available.');return AFRAME.registerComponent("yawvr",{schema:{appname:{type:"string",default:"myApp"},framerate:{type:"number",default:1}},multiple:!1,init:function(){this._ready=!1,this._lastTick=0;let e=this;this._registeredEventsPromise=e._findMiddleware().then((function(n){return e._middlewareAddress=n,e._findSimulator(n,/.*/)})).then((function([n,t]){return e.connect(n,t)})).then((function([n,t]){return e.checkIn(n,t,e.data.appname)})).then((function([n,t,o]){return e._registerUnloadEvents(n,t,o)})).catch((e=>(console.error("Init component: ",e),Promise.reject(e))))},update:function(e){this._interval=1e3/this.data.framerate},remove:function(){let e=this;this._registeredEventsPromise.then((function([n,t,o]){e.ready=!1,stop(n,t,o),exit(n,t,o)})).catch((e=>{console.log(e)}))},tick:function(e){if(this._ready&&e-this._lastTick>=this._interval){let n=THREE.MathUtils.radToDeg(this.el.object3D.rotation.y),t=THREE.MathUtils.radToDeg(this.el.object3D.rotation.x),o=THREE.MathUtils.radToDeg(this.el.object3D.rotation.z);fetch(this._middlewareAddress+"/SET_POSITION/"+n+"/"+t+"/"+o),this._lastTick=e}},pause:function(){let e=this;this._registeredEventsPromise.then((function([n,t,o]){return e.stop(n,t,o)})).then((function([n,t,o]){e._ready=!1})).catch((e=>{console.error(e)}))},play:function(){let e=this;this._registeredEventsPromise.then((function([n,t,o]){return e.start(n,t,o)})).then((function([n,t,o]){e._ready=!0})).catch((e=>{console.error("Playing component: ",e)}))},_registerUnloadEvents:function(e,n,t){return console.log("Registering unload event."),window.addEventListener("beforeunload",(function(n){console.log("Unloading window"),fetch(e+"/stop/",{keepalive:!0}).then((function(e){return e.json()})).then((function(e){console.log(e)})).catch((function(e){console.log(e)})),fetch(e+"/exit/",{keepalive:!0}).then((function(e){return e.json()})).then((function(e){console.log(e)})).catch((function(e){console.log(e)}))})),Promise.resolve([e,n,t])},_findMiddleware:function(){return new Promise((function(e,n){let t=2;console.log("Using Service Discovery: https://hmd-link-service.glitch.me/"),setTimeout((function o(){fetch("https://hmd-link-service.glitch.me/").then((function(e){return e.json()})).then((function(n){n.yawmiddleware?(console.log("Yaw Middleware found through service discovery: ",n.yawmiddleware),e(n.yawmiddleware.address)):(t=Math.min(2*t,30),console.log("Yaw Middleware not found through service discovery. Trying again in ",t," seconds."),setTimeout(o,1e3*t))})).catch((function(e){console.log(e),n(e)}))}),t)}))},_findSimulator:function(e,n){return new Promise((function(t,o){console.log("Asking Yaw Middleware: ",e," for existing simulators.");let i=2;setTimeout((function r(){fetch(e+"/simulators").then((function(e){return e.json()})).then((function(o){let c=null;o.length>0&&(console.log("Found simulators: ",o),o.forEach((e=>{e.simulatorName.match(n)&&(console.log("Found simulator matching '",n,"': ",e),c=e)}))),c?t([e,c]):(i=Math.min(2*i,30),console.log("No simulators found through middleware. Asking again in ",i," seconds."),setTimeout(r,1e3*i))})).catch((function(e){console.log(e),o(e)}))}),i)}))},connect:function(e,n){return new Promise(((t,o)=>{console.log("Connecting to: "+n.simulatorId),fetch(e+"/connect/"+n.simulatorId).then((function(e){return e.json()})).then((function(o){console.log("Connected to: "+n.simulatorId),t([e,n])})).catch((e=>{console.log(e),o(e)}))}))},checkIn:function(e,n,t){return new Promise(((o,i)=>{let r=t+crypto.randomUUID(),c=!1;console.log("Checking in app: ",r),fetch(e+"/checkin/"+r).then((function(e){return e.json()})).then((function(t){"AVAILABLE"==t.devicestatus&&(c=!0),c?(console.log("Checked in: ",t),o([e,n,r])):(console.log("Could not check in: ",t),i(t))})).catch((function(e){console.log(e),i(error)}))}))},start:function(e,n,t){return new Promise(((o,i)=>{console.log("Starting app: ",t),fetch(e+"/start/").then((function(e){return e.json()})).then((function(r){"START"==r.commandreceived?(console.log("Started"),o([e,n,t])):(console.log("Could not start",r),i(r))})).catch((function(e){console.log(e),i(error)}))}))},stop:function(e,n,t){return new Promise(((o,i)=>{console.log("Stopping app: ",t),fetch(e+"/stop/",{keepalive:!0}).then((function(e){return e.json()})).then((function(r){"STOP"==r.commandreceived?(console.log("Stopped"),o([e,n,t])):(console.log("Could not stop",r),i(r))})).catch((function(e){console.log(e),i(error)}))}))},exit:function(e,n,t){return new Promise(((o,i)=>{console.log("Exiting app: ",t),fetch(e+"/exit/",{keepalive:!0}).then((function(e){return e.json()})).then((function(r){"EXIT"==r.commandreceived?(console.log("Exited"),o([e,n,t])):(console.log("Could not exit",r),i(r))})).catch((function(e){console.log(e),i(error)}))}))}}),{}})()));