!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var o in n)("object"==typeof exports?exports:e)[o]=n[o]}}(this,(()=>(()=>{if("undefined"==typeof AFRAME)throw new Error('Component "yawvr" attempted to register before AFRAME was available.');return AFRAME.registerComponent("yawvr",{schema:{appname:{type:"string",default:"myApp"},yawlimit:{type:"number",default:180},pitchforwardlimit:{type:"number",default:15},pitchbackwardlimit:{type:"number",default:55},rolllimit:{type:"number",default:20},motioncompensation:{type:"boolean",default:!1},middlewareaddress:{type:"string",default:""},servicediscoveryaddress:{type:"string",default:"https://hmd-link-service.glitch.me"}},multiple:!1,init:function(){this._ready=!1;let e=this;this._camera=this.el.querySelector("[camera],a-camera"),this.data.motioncompensation&&(this._cameraParent=this._camera.parentElement);let t=null;t=""==e.data.middlewareaddress?e._findMiddleware(this.data.servicediscoveryaddress):Promise.resolve(e.data.middlewareaddress),this._registeredEventsPromise=t.then((function(t){return e._middlewareAddress=t,e._findSimulator(t,/.*/)})).then((function([t,n]){return e.connect(t,n)})).then((function([t,n]){return e.checkIn(t,n,e.data.appname)})).then((function([t,n,o]){return e._registerUnloadEvents(t,n,o)})).catch((e=>(console.error("Init component: ",e),Promise.reject(e))))},update:function(e){let t=this;this._interval=1e3/this.data.rate,this._registeredEventsPromise.then((([e,n,o])=>t.setTiltLimits(e,n,o,t.data.pitchforwardlimit,t.data.pitchbackwardlimit,t.data.rolllimit))).then((([e,n,o])=>t.setYawLimit(e,n,o,t.data.yawlimit))).catch((e=>{console.error("Updating component: ",e)}))},remove:function(){let e=this;this._registeredEventsPromise.then((function([t,n,o]){e.ready=!1,e.stop(t,n,o),e.exit(t,n,o)})).catch((e=>{console.log(e)}))},tick:function(e){if(!this._ready)return;let t=THREE.MathUtils.radToDeg(-this.el.object3D.rotation.y),n=THREE.MathUtils.radToDeg(this.el.object3D.rotation.x),o=THREE.MathUtils.radToDeg(this.el.object3D.rotation.z);if(this.sendWebSocketMessage(t+" "+n+" "+o),this.data.motioncompensation){let e=this.yCurrent-this.yPrevious;this.yPrevious=this.yCurrent,this._cameraParent.object3D.rotation.y+=THREE.MathUtils.degToRad(e),this._cameraParent.object3D.updateMatrix()}},pause:function(){let e=this;this._registeredEventsPromise.then((function([t,n,o]){return this._socket.close(),e.stop(t,n,o)})).then((function([t,n,o]){e._ready=!1})).catch((e=>{console.error(e)}))},play:function(){let e=this;this._registeredEventsPromise.then((function([t,n,o]){return e._socket=new WebSocket("wss://"+t.substring(6)),e.yCurrent=null,e.yPrevious=null,e._socket.addEventListener("open",e.onWebSocketOpen.bind(e)),e.start(t,n,o)})).then((function([t,n,o]){e._ready=!0})).catch((e=>{console.error("Playing component: ",e)}))},onWebSocketOpen:function(){this._socket.addEventListener("message",this.onWebSocketMessage)},onWebSocketMessage:function(e){let t=e.data.split(" ");null==this.yPrevious&&(this.yPrevious=t[0]),this.yCurrent=t[0]},sendWebSocketMessage:function(e){this._socket.send(e)},_registerUnloadEvents:function(e,t,n){return console.info("Registering unload event."),window.addEventListener("beforeunload",(function(t){console.log("Unloading window"),fetch(e+"/stop/",{keepalive:!0}).then((function(e){return e.json()})).then((function(e){console.log(e)})).catch((function(e){console.log(e)})),fetch(e+"/exit/",{keepalive:!0}).then((function(e){return e.json()})).then((function(e){console.log(e)})).catch((function(e){console.log(e)}))})),Promise.resolve([e,t,n])},_findMiddleware:function(e){return new Promise((function(t,n){let o=2;console.info("Using Service Discovery: ",e),setTimeout((function i(){fetch(e).then((function(e){return e.json()})).then((function(e){e.yawmiddleware?(console.info("Yaw Middleware found through service discovery: ",e.yawmiddleware),t(e.yawmiddleware.address)):(o=Math.min(2*o,30),console.warn("Yaw Middleware not found through service discovery. Trying again in ",o," seconds."),setTimeout(i,1e3*o))})).catch((function(e){console.log(e),n(e)}))}),o)}))},_findSimulator:function(e,t){return new Promise((function(n,o){console.info("Asking Yaw Middleware: ",e," for existing simulators.");let i=2;setTimeout((function r(){fetch(e+"/simulators").then((function(e){return e.json()})).then((function(o){let s=null;o.length>0&&(console.debug("Found simulators: ",o),o.forEach((e=>{e.simulatorName.match(t)&&(console.info("Found simulator matching '",t,"': ",e),s=e)}))),s?n([e,s]):(i=Math.min(2*i,30),console.warn("No simulators found through middleware. Asking again in ",i," seconds."),setTimeout(r,1e3*i))})).catch((function(e){console.log(e),o(e)}))}),i)}))},connect:function(e,t){return new Promise(((n,o)=>{console.info("Connecting to: "+t.simulatorId),fetch(e+"/connect/"+t.simulatorId).then((function(e){return e.json()})).then((function(o){console.info("Connected to: "+t.simulatorId),n([e,t])})).catch((e=>{console.error(e),o(e)}))}))},checkIn:function(e,t,n){return new Promise(((o,i)=>{let r=n+crypto.randomUUID(),s=!1;console.info("Checking in app: ",r),fetch(e+"/checkin/"+r).then((function(e){return e.json()})).then((function(n){"AVAILABLE"==n.devicestatus&&(s=!0),s?(console.info("Checked in: ",n),o([e,t,r])):(console.warn("Could not check in: ",n),i(n))})).catch((function(e){console.error(e),i(e)}))}))},start:function(e,t,n){return new Promise(((o,i)=>{console.info("Starting app: ",n),fetch(e+"/start/").then((function(e){return e.json()})).then((function(r){"START"==r.commandreceived?(console.info("Started"),o([e,t,n])):(console.warn("Could not start",r),i(r))})).catch((function(e){console.error(e),i(e)}))}))},stop:function(e,t,n){return new Promise(((o,i)=>{console.info("Stopping app: ",n),fetch(e+"/stop/",{keepalive:!0}).then((function(e){return e.json()})).then((function(r){"STOP"==r.commandreceived?(console.info("Stopped"),o([e,t,n])):(console.warn("Could not stop",r),i(r))})).catch((function(e){console.error(e),i(e)}))}))},exit:function(e,t,n){return new Promise(((o,i)=>{console.info("Exiting app: ",n),fetch(e+"/exit/",{keepalive:!0}).then((function(e){return e.json()})).then((function(r){"EXIT"==r.commandreceived?(console.info("Exited"),o([e,t,n])):(console.warn("Could not exit",r),i(r))})).catch((function(e){console.error(e),i(e)}))}))},setTiltLimits:function(e,t,n,o,i,r){return new Promise(((s,c)=>{console.info("Setting tilt limits for ",n),fetch(e+"/set_tilt_limits/"+o+"/"+i+"/"+r).then((function(e){return e.json()})).then((function(o){"SET_TILT_LIMITS"==o.commandreceived?(console.info("Set tilt limits: ",o.pitchForwardLimit,o.pitchBackwardLimit,o.rollLimit),s([e,t,n,o])):(console.warn("Could set tilt limits",o),c(o))})).catch((function(e){console.error(e),c(e)}))}))},setYawLimit:function(e,t,n,o){return new Promise(((i,r)=>{console.info("Setting yaw limit for ",n),fetch(e+"/set_yaw_limit/"+o).then((function(e){return e.json()})).then((function(o){"SET_YAW_LIMIT"==o.commandreceived?(console.info("Set yaw limits: ",o.yawLimit),i([e,t,n,o])):(console.warn("Could set yaw limit",o),r(o))})).catch((function(e){console.error(e),r(e)}))}))}}),{}})()));